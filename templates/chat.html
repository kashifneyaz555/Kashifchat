<!DOCTYPE html>
<html>
<head>
  <title>KashifChat</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <div class="header">
    <img src="/static/default-avatar.png" class="header-avatar">
    <div class="header-info">
      <h2>KashifChat</h2>
      <p class="status-text">Online</p>
    </div>
    <button id="participants-btn" title="View participants">ğŸ‘¥</button>
    <label class="dark-toggle">
      ğŸŒ™ <input type="checkbox" id="dark-mode-toggle">
    </label>
  </div>

  <div class="container">
    <div id="chat-box"></div>
    <div id="participants-list" style="display:none;" class="system-message"></div>
    <div id="typing-indicator" class="typing-indicator"></div>

    <input type="text" id="message" placeholder="Type your message...">
    <button onclick="sendMessage()">Send</button>
    <input type="file" id="audio-upload" accept="audio/*">
    <input type="file" id="video-upload" accept="video/*">
    <input type="file" id="file-upload" accept=".pdf,.doc,.docx,.txt,.zip">
    <a href="/logout">Logout</a>
  </div>

  <audio id="notify" src="/static/notify.mp3" preload="auto"></audio>

  <script>
    const socket = io();
    const chatBox = document.getElementById("chat-box");
    const notify = document.getElementById("notify");
    const typingIndicator = document.getElementById("typing-indicator");
    const participantsList = document.getElementById("participants-list");

    const toggle = document.getElementById("dark-mode-toggle");
    if (localStorage.getItem("darkMode") === "true") {
      document.body.classList.add("dark");
      toggle.checked = true;
    }
    toggle.addEventListener("change", () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("darkMode", toggle.checked);
    });

    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) {
        socket.emit("active_view", { username: "{{ username }}" });
      }
    });

    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    socket.on("receive_message", data => {
      const msg = document.createElement("div");
      msg.classList.add("chat-message", data.username === "{{ username }}" ? "me" : "them");
      msg.dataset.id = data.id;

      const tickClass = data.status === "âœ…âœ…" ? "seen-purple" : "";

      msg.innerHTML = `
        <div class="bubble">
          <span class="msg-text">${data.message}</span>
          <span class="timestamp">${data.timestamp}</span>
          <span class="status ${tickClass}">${data.status}</span>
          <div class="hover-actions">
            <div class="reactions">
              <button onclick="react('${data.id}', 'ğŸ‘')">ğŸ‘</button>
              <button onclick="react('${data.id}', 'â¤ï¸')">â¤ï¸</button>
              <button onclick="react('${data.id}', 'ğŸ˜‚')">ğŸ˜‚</button>
              <button onclick="react('${data.id}', 'ğŸ˜®')">ğŸ˜®</button>
              <button onclick="react('${data.id}', 'ğŸ˜¢')">ğŸ˜¢</button>
            </div>
            ${data.username === "{{ username }}" ? `
              <button class="action-btn" onclick="editMessage('${data.id}')">âœï¸</button>
              <button class="action-btn" onclick="deleteMessage('${data.id}')">ğŸ—‘ï¸</button>
            ` : ""}
          </div>
        </div>
      `;

      msg.classList.add("fade-in");
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
      notify.currentTime = 0;
      notify.play().catch(() => {});
      if (Notification.permission === "granted" && data.username !== "{{ username }}") {
        new Notification("New message from " + data.username, { body: data.message });
      }
      socket.emit("message_seen", { id: data.id });
    });

    socket.on("update_message", data => {
      const msg = document.querySelector(`[data-id="${data.id}"]`);
      if (msg) {
        msg.querySelector(".msg-text").textContent = data.new_message;
      }
    });

    socket.on("remove_message", data => {
      const msg = document.querySelector(`[data-id="${data.id}"]`);
      if (msg) msg.remove();
    });

    socket.on("message_seen", data => {
      const msg = document.querySelector(`[data-id="${data.id}"]`);
      if (msg) {
        const status = msg.querySelector(".status");
        if (status) {
          status.textContent = "âœ…âœ…";
          status.classList.add("seen-purple");
        }
      }
    });

    socket.on("receive_audio", data => {
      const msg = document.createElement("div");
      msg.classList.add("chat-message", data.username === "{{ username }}" ? "me" : "them");
      msg.dataset.id = data.id;
      msg.innerHTML = `
        <div class="bubble">
          <audio controls src="${data.audio_data}"></audio>
          <span class="timestamp">${data.timestamp}</span>
        </div>
      `;
      msg.classList.add("fade-in");
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on("receive_video", data => {
      const msg = document.createElement("div");
      msg.classList.add("chat-message", data.username === "{{ username }}" ? "me" : "them");
      msg.dataset.id = data.id;
      msg.innerHTML = `
        <div class="bubble">
          <video controls width="100%" src="${data.video_data}"></video>
          <span class="timestamp">${data.timestamp}</span>
        </div>
      `;
      msg.classList.add("fade-in");
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on("receive_file", data => {
      const msg = document.createElement("div");
      msg.classList.add("chat-message", data.username === "{{ username }}" ? "me" : "them");
      msg.dataset.id = data.id;
      msg.innerHTML = `
        <div class="bubble">
          <a href="${data.file_url}" download>${data.file_name}</a>
          <span class="timestamp">${data.timestamp}</span>
        </div>
      `;
      msg.classList.add("fade-in");
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on("user_typing", data => {
      typingIndicator.textContent = `${data.username} is typing...`;
      setTimeout(() => {
        typingIndicator.textContent = "";
      }, 1000);
    });

    socket.on("user_left", data => {
      const notice = document.createElement("div");
      notice.className = "system-message";
      notice.textContent = `${data.username} logged out`;
      chatBox.appendChild(notice);
    });

    socket.on("participants_list", data => {
      participantsList.innerHTML = "<strong>Participants:</strong><br>" + data.users.map(u => `â€¢ ${u}`).join("<br>");
      participantsList.style.display = "block";
    });

    document.getElementById("participants-btn").onclick = () => {
      socket.emit("get_participants");
    };

    document.getElementById("message").addEventListener("input", () => {
      socket.emit("user_typing", { username: "{{ username }}" });
    });

    document.getElementById("audio-upload").addEventListener("change", event => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          socket.emit("send_audio", { audio_data: reader.result });
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById("video-upload").addEventListener("change", event => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          socket.emit("send_video", { video_data: reader.result });
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById("file-upload").addEventListener("change", event => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          socket.emit("send_file", {