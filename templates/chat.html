<!DOCTYPE html>
<html>
<head>
  <title>KashifChat</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <div class="header">
    <img src="/static/default-avatar.png" class="header-avatar">
    <div class="header-info">
      <h2>KashifChat</h2>
      <p class="status-text">Online</p>
    </div>
    <label class="dark-toggle">
      ğŸŒ™ <input type="checkbox" id="dark-mode-toggle">
    </label>
  </div>

  <div class="container">
    <div id="chat-box"></div>
    <div id="typing-indicator" class="typing-indicator"></div>

    <input type="text" id="message" placeholder="Type your message...">
    <button onclick="sendMessage()">Send</button>
    <input type="file" id="audio-upload" accept="audio/*">
    <a href="/logout">Logout</a>
  </div>

  <audio id="notify" src="/static/notify.mp3" preload="auto"></audio>

  <script>
    const socket = io();
    const chatBox = document.getElementById("chat-box");
    const notify = document.getElementById("notify");
    const typingIndicator = document.getElementById("typing-indicator");

    const toggle = document.getElementById("dark-mode-toggle");
    if (localStorage.getItem("darkMode") === "true") {
      document.body.classList.add("dark");
      toggle.checked = true;
    }
    toggle.addEventListener("change", () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("darkMode", toggle.checked);
    });

    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    socket.on("receive_message", data => {
      const msg = document.createElement("div");
      msg.classList.add("chat-message", data.username === "{{ username }}" ? "me" : "them");
      msg.dataset.id = data.id;

      msg.innerHTML = `
        <div class="bubble">
          <span class="msg-text">${data.message}</span>
          <span class="timestamp">${data.timestamp}</span>
          <span class="status">âœ…</span>
          <div class="hover-actions">
            <div class="reactions">
              <button onclick="react('${data.id}', 'ğŸ‘')">ğŸ‘</button>
              <button onclick="react('${data.id}', 'â¤ï¸')">â¤ï¸</button>
              <button onclick="react('${data.id}', 'ğŸ˜‚')">ğŸ˜‚</button>
              <button onclick="react('${data.id}', 'ğŸ˜®')">ğŸ˜®</button>
              <button onclick="react('${data.id}', 'ğŸ˜¢')">ğŸ˜¢</button>
            </div>
            ${data.username === "{{ username }}" ? `
              <button class="action-btn" onclick="editMessage('${data.id}')">âœï¸</button>
              <button class="action-btn" onclick="deleteMessage('${data.id}')">ğŸ—‘ï¸</button>
            ` : ""}
          </div>
        </div>
      `;

      msg.classList.add("fade-in");
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
      notify.currentTime = 0;
      notify.play().catch(() => {});
      if (Notification.permission === "granted" && data.username !== "{{ username }}") {
        new Notification("New message from " + data.username, { body: data.message });
      }
      socket.emit("message_seen", { id: data.id });
    });

    socket.on("update_message", data => {
      const msg = document.querySelector(`[data-id="${data.id}"]`);
      if (msg) {
        msg.querySelector(".msg-text").textContent = data.new_message;
      }
    });

    socket.on("remove_message", data => {
      const msg = document.querySelector(`[data-id="${data.id}"]`);
      if (msg) msg.remove();
    });

    socket.on("message_seen", data => {
      const msg = document.querySelector(`[data-id="${data.id}"]`);
      if (msg) {
        const status = msg.querySelector(".status");
        if (status) status.textContent = "âœ…âœ…";
        status.classList.add("seen");
      }
    });

    socket.on("receive_audio", data => {
      const msg = document.createElement("div");
      msg.classList.add("chat-message", data.username === "{{ username }}" ? "me" : "them");
      msg.dataset.id = data.id;
      msg.innerHTML = `
        <div class="bubble">
          <audio controls src="${data.audio_data}"></audio>
          <span class="timestamp">${data.timestamp}</span>
        </div>
      `;
      msg.classList.add("fade-in");
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on("user_typing", data => {
      typingIndicator.textContent = `${data.username} is typing...`;
      setTimeout(() => {
        typingIndicator.textContent = "";
      }, 1000);
    });

    document.getElementById("message").addEventListener("input", () => {
      socket.emit("user_typing", { username: "{{ username }}" });
    });

    document.getElementById("audio-upload").addEventListener("change", event => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          socket.emit("send_audio", { audio_data: reader.result });
        };
        reader.readAsDataURL(file);
      }
    });

    function sendMessage() {
      const input = document.getElementById("message");
      const message = input.value.trim();
      if (message) {
        socket.emit("send_message", { message });
        input.value = "";
      }
    }

    function react(id, emoji) {
      const msg = document.querySelector(`[data-id="${id}"]`);
      if (msg) {
        const bubble = msg.querySelector(".bubble");
        const reaction = document.createElement("span");
        reaction.textContent = emoji;
        reaction.className = "reaction";
        bubble.appendChild(reaction);
      }
    }

    function editMessage(id) {
      const msg = document.querySelector(`[data-id="${id}"]`);
      const currentText = msg.querySelector(".msg-text").textContent;
      const newText = prompt("Edit your message:", currentText);
      if (newText) {
        socket.emit("edit_message", { id, new_message: newText });
      }
    }

    function deleteMessage(id) {
      socket.emit("delete_message", { id });
    }
  </script>
</body>
</html>